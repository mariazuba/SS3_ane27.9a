---
title: "Transición de  archivos de datos GADGET a SS3 de boqueron Cádiz"
author: " "
date: '`r format(Sys.Date(),"%B, %d, %Y")`'
output: 
  pdf_document:
   toc: TRUE
   toc_depth: '3'
   number_sections: yes
urlcolor: blue   
---

\newpage

```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=T, warning=FALSE, message=FALSE,collapse=TRUE,fig.align="center",fig.pos="h!")
```





\newpage
# Descripción del repositorio

- Directorio con archivos requeridos para ejecutar GADGET
- Directorio con archivos requeridos para ejecutar SS3
- Directorio con ejecutable SS3 para tres sistemas operativos (windows, linux y mac)
- Códigos Rmarkdown (pdf o html) que permita modificar archivos SS3
    - formato data.ss
    - formato contro.ss
    - formato starter.ss
    - formato forecast.ss

# Descargar archivos requeridos desde repositorio

Tarea pendiente....

# Librerias requeridas


```{r results='hide',include=FALSE}
## Librerías requeridas
 paquetes <- c("stringr", "tidyverse", "kableExtra","ggplot2","ggthemes",
               "patchwork","dplyr","reshape","here","r4ss","zoo")
 lapply(paquetes, require, character.only = TRUE)
```



# Descripción del Formado de entrada de datos requerido para cada enfoque de modelación

## Identificación de los archivos de  datos GADGET

Se utilizarán los siguientes archivos de entrada de datos de Gadget:

```{r}
dir(here('Data_Gadget'))
```

### Capturas en formato `Gadget`

Capturas anuales del stock (toneladas)

```{r}

# Se lee archivo de entrada Gadget
capturas<-read.table(file=here('Data_Gadget',"fleet.seine.data"),
                         header=F,sep="",na='NA',fill=T,skip = 3) %>% 
             magrittr::set_colnames(c('year','step','area','vessel','number'))
head(capturas)
```

```{r fig.height=3,fig.width=6,echo=F}

capturaplot<-capturas %>% mutate(ytr=as.yearqtr(year + step/4))

ggplot(capturaplot,aes(x=ytr,y=number/1000000))+
  geom_line()+
  geom_point()+
   labs(x="Años/Trimestres", y="Capturas en número (millones)") +  
   theme_bw() + 
scale_x_yearqtr(format = "%Y-T%q")



```


```{r fig.height=3,fig.width=4,echo=FALSE}
ggplot(capturaplot) +
    geom_boxplot(aes(x = as.factor(step), y = number/1000000),notch = TRUE) +  
   labs(x="Trimestres", y="Capturas en numero") +  
   theme_bw() + 
    theme(plot.title = element_text(size = 12))

```


```{r fig.height=3,fig.width=8,echo=FALSE}
ggplot(capturaplot) +
    geom_boxplot(aes(x = as.factor(year), y = number/1000000)) +  
   labs(x="Años", y="Capturas en numero") +  
   theme_bw() + 
    theme(plot.title = element_text(size = 12))

```

### Indices de abundancia formato `Gadget`


```{r}
#----------------------------------------------------------------------------------------
pelago<-read.table(file=here('Data_Gadget',"surveyindices.pelagonumber.survey.lengths"),
                         header=F,sep="",na='NA',fill=T,skip = 3) %>% 
                     magrittr::set_colnames(c('year','step','area','length','number'))
head(pelago)
#----------------------------------------------------------------------------------------
ecocadiz<-read.table(file=here('Data_Gadget',"surveyindices.ecocadiz.survey.lengths"),
                         header=F,sep="",na='NA',fill=T,skip = 3)%>% 
                     magrittr::set_colnames(c('year','step','area','length','number'))
head(ecocadiz)
#----------------------------------------------------------------------------------------
```



```{r fig.height=5,fig.width=6,echo=FALSE}

pelago1  <-data.frame(yrs=pelago$year,PELAGO=pelago$number)
ecocadiz1<-data.frame(yrs=ecocadiz$year,ECOCADIZ=ecocadiz$number)
indexplot<-merge(pelago1,ecocadiz1,by="yrs",all=TRUE) %>% melt(id.vars="yrs")

ggplot()  +
    geom_bar(data=indexplot, aes(x=yrs, y =value), 
             stat="identity", fill='gray66', color = 'gray28') + 
    facet_wrap(~variable,scale="free",dir = 'v', as.table = TRUE) + 
    labs(x="Años", y="Índices de abundancia") +  
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color="gray66"))

```


### Composiciones de tallas Formato `Gadget`

```{r}
#---------------------------------------------------------------------------------
tallaspelago<-read.table(file=here('Data_Gadget',"catchdistribution.ldist.pelago.noage.sumofsquares"),
                         header=F,sep="",na='NA',fill=T,skip = 3) %>% 
               magrittr::set_colnames(c('year','step','area','age','length','number')) %>%
                      separate(length,into=c("text","length"),sep=3,convert =TRUE)

head(tallaspelago)
#---------------------------------------------------------------------------------
tallasecocadiz<-read.table(file=here('Data_Gadget',"catchdistribution.ldist.ecocadiz.noage.sumofsquares"),
                         header=F,sep="",na='NA',fill=T,skip = 3) %>% 
               magrittr::set_colnames(c('year','step','area','age','length','number')) %>%
                      separate(length,into=c("text","length"),sep=3,convert =TRUE)

head(tallasecocadiz)
#---------------------------------------------------------------------------------
tallasflota<-read.table(file=here('Data_Gadget',"catchdistribution.ldist.seine.sumofsquares"),
                         header=F,sep="",na='NA',fill=T,skip = 3) %>% 
               magrittr::set_colnames(c('year','step','area','age','length','number')) %>%
                      separate(length,into=c("text","length"),sep=3,convert =TRUE)

head(tallasflota) 
#---------------------------------------------------------------------------------

```


```{r fig.height=10,fig.width=10,echo=FALSE}

ggplot(tallaspelago) + 
    geom_bar(aes(x = length, y = number/1000000), stat="identity", fill='gray66', color = 'gray28') + 
    facet_grid(year~step,  as.table = TRUE,scales = "free") + 
    labs(x = 'Tallas', y = 'Abundancia en número') +
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color=NA)) + 
     ggtitle('PELAGO')+
    theme(plot.title = element_text(size = 8))

```



```{r fig.height=10,fig.width=10,echo=FALSE}

ggplot(tallasecocadiz) + 
    geom_bar(aes(x = length, y = number/1000000), stat="identity", fill='gray66', color = 'gray28') + 
   facet_grid(year~step,  as.table = TRUE,scales = "free") + 
    labs(x = 'Tallas', y = 'Abundancia en número') +
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color=NA)) + 
     ggtitle('ECOCADIZ')+
    theme(plot.title = element_text(size = 8))

```

```{r fig.height=15,fig.width=10,echo=FALSE}

ggplot(tallasflota) + 
    geom_bar(aes(x = length, y = number/1000000), stat="identity", fill='gray66', color = 'gray28') + 
    facet_grid(year~step,  as.table = TRUE,scales = "free") + 
    labs(x = 'Tallas', y = 'Abundancia en número') +
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color=NA)) + 
     ggtitle('FLOTA')+
    theme(plot.title = element_text(size = 8))

```

#### Tallas medias 
```{r fig.height=2.5,fig.width=4,echo=FALSE}

mediaTalla_flota<-as.numeric(tallasflota$length)*as.numeric(tallasflota$number)

TallasMedias_flota<-tallasflota %>% mutate(ytr=as.yearqtr(year + step/4))%>% mutate(value2=mediaTalla_flota) %>% group_by(ytr) %>% 
  summarize(sum1 = sum(number),sum2 = sum(value2)) %>% mutate(Lmed=sum2/sum1)

ggplot(TallasMedias_flota,aes(x=ytr,y=Lmed))+ 
  geom_point()+
   geom_smooth()+
  #geom_line()+ 
  lims(y=c(5,15))+
    labs(x = 'Años', y = 'Tallas medias (cm)') +
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color=NA)) + 
     ggtitle('Flota')+
    theme(plot.title = element_text(size = 10))+ 
    theme_bw(base_size=8) +
scale_x_yearqtr(format = "%Y-T%q")

```

```{r fig.height=2.5,fig.width=4,echo=FALSE}

mediaTalla_pelago<-as.numeric(tallaspelago$length)*as.numeric(tallaspelago$number)

TallasMedias_pelago<-tallaspelago %>% mutate(ytr=as.yearqtr(year + step/4))%>% mutate(value2=mediaTalla_pelago) %>% group_by(ytr) %>% 
  summarize(sum1 = sum(number),sum2 = sum(value2)) %>% mutate(Lmed=sum2/sum1)

ggplot(TallasMedias_pelago,aes(x=ytr,y=Lmed))+ 
  geom_point()+
   geom_smooth()+
  #geom_line()+ 
  lims(y=c(5,15))+
    labs(x = 'Años', y = 'Tallas medias (cm)') +
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color=NA)) + 
     ggtitle('Pelago')+
    theme(plot.title = element_text(size = 10))+ 
    theme_bw(base_size=8) +
scale_x_yearqtr(format = "%Y-T%q")

```

```{r fig.height=2.5,fig.width=4,echo=FALSE}

mediaTalla_ecocadiz<-as.numeric(tallasecocadiz$length)*as.numeric(tallasecocadiz$number)

TallasMedias_ecocadiz<-tallasecocadiz %>% mutate(ytr=as.yearqtr(year + step/4))%>% mutate(value2=mediaTalla_ecocadiz) %>% group_by(ytr) %>% 
  summarize(sum1 = sum(number),sum2 = sum(value2)) %>% mutate(Lmed=sum2/sum1)

ggplot(TallasMedias_ecocadiz,aes(x=ytr,y=Lmed))+ 
  geom_point()+
   geom_smooth()+
  #geom_line()+ 
  lims(y=c(5,15))+
    labs(x = 'Años', y = 'Tallas medias (cm)') +
    theme(panel.background = element_rect(fill ="gray99")) + 
    theme(panel.grid=element_line(color=NA)) + 
     ggtitle('Ecocadiz')+
    theme(plot.title = element_text(size = 10))+ 
    theme_bw(base_size=8) +
scale_x_yearqtr(format = "%Y-T%q")

```

### Clave talla-edad formato `Gadget`

```{r }

pelago.aldist<-read.table(file=here("Data_Gadget","catchdistribution.aldist.pelago.sumofsquares"),
                        header=F,sep="",na='NA',fill=T,skip = 3)
names(pelago.aldist)<-c('year','step','area','age','length','number')


pelago.aldist$fleet   <- 2
pelago.aldist$sex     <- 0
pelago.aldist$part    <- 0
pelago.aldist$ageerr  <- 2
pelago.aldist$Lbin_lo <- pelago.aldist$length
pelago.aldist$Lbin_hi <- pelago.aldist$length
pelago.aldist$Nsamp   <- 10

pelago.aldist_xxx<- pelago.aldist %>%
                   separate(length,into=c("text","length"),sep=3,convert=TRUE)


# Se transforma a formato SS3
pelago.aldistSS3<- pelago.aldist %>%
                   separate(length,into=c("text","length"),sep=3,convert=TRUE)%>% 
                   separate(Lbin_lo,into=c("text","Lbin_lo"),sep=3,convert=TRUE)%>% 
                   separate(Lbin_hi,into=c("text","Lbin_hi"),sep=3,convert=TRUE)%>% 
                   arrange("Lbin_lo","Lbin_hi",'year','step','part','ageerr','Nsamp')%>% 
                   spread(age,number)%>% 
                   select(-area,-length,-text)
pelago.aldistSS3[is.na(pelago.aldistSS3)] <- 0



```


```{r}

tallaspelago

pelago.aldistSS3
```



```{r fig.height=15,fig.width=10,echo=FALSE}
ggplot(pelago.aldist_xxx, aes(x=length, y=number,group=age,colour=as.character(age))) + 
    geom_line()+
    facet_grid(year~step,  as.table = TRUE,scales = "free") +
    labs(x = 'Tallas', y = 'Abundancia en número') +
    scale_colour_discrete(name  ="Grupos de Edad",
                            labels=seq(0,4))+
    theme(panel.background = element_rect(fill ="gray99")) +
    theme(panel.grid=element_line(color=NA)) +
     ggtitle('PELAGO')+
    theme(plot.title = element_text(size = 8))
```


```{r }

ecocadiz.aldist<-read.table(file=here("Data_Gadget","catchdistribution.aldist.ecocadiz.sumofsquares"),
                        header=F,sep="",na='NA',fill=T,skip = 3)
names(ecocadiz.aldist)<-c('year','step','area','age','length','number')

ecocadiz.aldist$fleet   <- 3
ecocadiz.aldist$sex     <- 0
ecocadiz.aldist$part    <- 0
ecocadiz.aldist$ageerr  <- 2
ecocadiz.aldist$Lbin_lo <- ecocadiz.aldist$length
ecocadiz.aldist$Lbin_hi <- ecocadiz.aldist$length
ecocadiz.aldist$Nsamp   <- 10

ecocadiz.aldist_xxx<- ecocadiz.aldist %>%
                   separate(length,into=c("text","length"),sep=3,convert=TRUE)

# Se transforma a formato SS3
ecocadiz.aldistSS3  <-ecocadiz.aldist %>%
                      separate(length,into=c("text","length"),sep=3,convert=TRUE)%>% 
                      separate(Lbin_lo,into=c("text","Lbin_lo"),sep=3,convert=TRUE)%>% 
                      separate(Lbin_hi,into=c("text","Lbin_hi"),sep=3,convert=TRUE)%>% 
                      arrange("Lbin_lo","Lbin_hi",'year','step','part','ageerr','Nsamp')%>% 
                      spread(age,number)%>% 
                      select(-area,-length,-text)
ecocadiz.aldistSS3[is.na(ecocadiz.aldistSS3)] <- 0

```


```{r fig.height=8,fig.width=8,echo=FALSE}
ggplot(ecocadiz.aldist_xxx, aes(x=length, y=number,group=age,colour=as.character(age))) + 
    geom_line()+
    facet_grid(year~step,  as.table = TRUE,scales = "free") +
    labs(x = 'Tallas', y = 'Abundancia en número') +
    scale_colour_discrete(name  ="Grupos de Edad",
                            labels=seq(0,4))+
    theme(panel.background = element_rect(fill ="gray99")) +
    theme(panel.grid=element_line(color=NA)) +
     ggtitle('ECOCADIZ')+
    theme(plot.title = element_text(size = 8))
```


```{r }

fleet.ldist.alkseine<-read.table(file=here("Data_Gadget","catchdistribution.ldist.alkseine.sumofsquares"),
                        header=F,sep="",na='NA',fill=T,skip = 3)
names(fleet.ldist.alkseine)<-c('year','step','area','age','length','number')

fleet.ldist.alkseine$fleet   <- 3
fleet.ldist.alkseine$sex     <- 0
fleet.ldist.alkseine$part    <- 0
fleet.ldist.alkseine$ageerr  <- 2
fleet.ldist.alkseine$Lbin_lo <- fleet.ldist.alkseine$length
fleet.ldist.alkseine$Lbin_hi <- fleet.ldist.alkseine$length
fleet.ldist.alkseine$Nsamp   <- 10

fleet.ldist.alkseine_xxx <- fleet.ldist.alkseine %>%
                           separate(length,into=c("text","length"),sep=3,convert=TRUE)


# Se transforma a formato SS3
fleet.ldist.alkseineSS3    <- fleet.ldist.alkseine %>%
                              separate(length,into=c("text","length"),sep=3,convert=TRUE)%>% 
                              separate(Lbin_lo,into=c("text","Lbin_lo"),sep=3,convert=TRUE)%>% 
                              separate(Lbin_hi,into=c("text","Lbin_hi"),sep=3,convert=TRUE)%>% 
                              arrange("Lbin_lo","Lbin_hi",'year','step','part','ageerr','Nsamp')%>% 
                              spread(age,number)%>% 
                              select(-area,-length,-text)
fleet.ldist.alkseineSS3[is.na(fleet.ldist.alkseineSS3)] <- 0


```


```{r fig.height=12,fig.width=8,echo=FALSE}
ggplot(fleet.ldist.alkseine_xxx, aes(x=length, y=number,group=age,colour=as.character(age))) + 
    geom_line()+
    facet_grid(year~step,  as.table = TRUE,scales = "free") +
    labs(x = 'Tallas', y = 'Abundancia en número') +
    scale_colour_discrete(name  ="Grupos de Edad",
                            labels=seq(0,4))+
    theme(panel.background = element_rect(fill ="gray99")) +
    theme(panel.grid=element_line(color=NA)) +
     ggtitle('FLOTA')+
    theme(plot.title = element_text(size = 6))
```

## Parámetros biológicos

### Mortalidad natural


```{r}

Edad<-seq(0,3,1)
Medad<-c(2.21,1.3,1.3,1.3)

dataM<-data.frame(Edad,M=Medad)

ggplot(dataM,aes(x=Edad,y=M))+
       geom_point()+geom_line()+
       lims(y=c(0,2.5))+  
   theme_bw()

```





\newpage

## Identificación de los archivos de  datos SS3

### Archivos utilizado para enfoque de modelación `SS3`

#### Identificamos el directorio donde se encuentra el modelo base 
\quad
```{r}
#bajarlo desde Github SS3
dirname.base <- here("modelos_SS3","simple")
#dirname.base <- here("10a_anchcadiz")

```

#### Creamos un nuevo directorio para la nueva versión del modelo modificado 
\quad
```{r}
dirname.simple_mod <- here("boqueron_SS3")
#dir.create(path=dirname.simple_mod, showWarnings = TRUE, recursive = TRUE)
```

#### Copiamos los archivos para el modelo que vamos a  modificar
\quad
```{r}
copy_SS_inputs(dir.old = dirname.base, 
               dir.new = dirname.simple_mod,
               copy_exe = TRUE,
               verbose = FALSE)
```

### Información general del modelo Formato `SS3`

En la parte superior se especifica información general del modelo: los años del modelo, número de temporadas, número de sexos, edad máxima, número de áreas, número de flotas  

[Consulte la Guía de usuario de SS3: Sección 7.5 "Model Dimensions"](https://nmfs-stock-synthesis.github.io/doc/SS330_User_Manual.html#model-dimensions).


Revisamos los nombres de los componentes de la lista del archivo `.dat`

```{r}

#dat <- r4ss::SS_readdat(here(dirname.base,"monthanch.dat")) #base
dat <- r4ss::SS_readdat(here(dirname.base,"data.ss")) #base
dat1<-dat # para modificar
#names(dat1) # muestra los objetos de la lista
```



```{r}
#Especificaciones iniciales
dat1$Comments       <- "#C 2022 Anchoveta Cadiz data file MODELO TRIMESTRAL"
dat1$styr           <-1989  #_StartYr
dat1$endyr          <-2022  #_EndYr
dat1$nseas          <-4     #_Nseas
dat1$months_per_seas<-c(3,3,3,3)    #_months/season
dat1$Nsubseasons    <-2     #_Nsubseasons (even number, minimum is 2)
dat1$spawn_month    <-8     #_spawn_month (puesta alrededor de junio)
dat1$Ngenders       <-1    #_Ngenders: 1, 2, -1  (use -1 for 1 sex setup with SSB 
                            # multiplied by female_frac parameter)
dat1$Nsexes         <-1
dat1$Nages          <-4    #_Nages=accumulator age, first age is always age 0
dat1$N_areas        <-1     #_Nareas
dat1$Nfleets        <-3     #_Nfleets (including surveys)

dat1[1:15]
```

### Capturas en formato `SS3`

Primero ingresamos las especificaciones de los Datos de captura de la flota

[Consulte la Guía de usuario de SS3: Sección 7.9 "Catch"](https://nmfs-stock-synthesis.github.io/doc/SS330_User_Manual.html#catch).


#### Especificaciones de datos de captura
\quad

 `fleetinfo` es una matriz donde se ingresan las especificaciones de los datos de captura y debe contener la siguiente información:

- `type`: **1**=catch fleet; **2**=bycatch only fleet; **3**=survey; **4**=ignore 
- `surveytiming`: -1 for fishing fleet to use season-long catch-at-age for observations, or 1 to use observation month;  (always 1 for surveys)
- `area`:  area the fleet/survey operates in 
- `units`:  **1**=bio; **2**=num (ignored for surveys; their units read later)
- `need_catch_mult`: **0**=no; **1**=yes
- `fleetname`: 

```{r}
#---------------------------------------------------------------------------------
# Arreglo de datos
fleetnames1       <-c("FLOTA", "PELAGO", "ECOCADIZ")     
type1             <-c(1,3,3)
surveytiming1     <-c(-1,0.08,0.4) 
units_of_catch1   <-c(2,2,2) # flota comercial y ambas campañas en número
areas1            <-c(1,1,1) 
need_catch_mult1  <-c(0,0,0)

fleetinfo1<-data.frame(type            = type1,
                       surveytiming    = surveytiming1,
                       area            = areas1,
                       units           = units_of_catch1,
                       need_catch_mult = need_catch_mult1,
                       fleetname       = fleetnames1)
dat1$fleetinfo<-fleetinfo1     
#---------------------------------------------------------------------------------
# revisar salida final
dat1$fleetinfo
#---------------------------------------------------------------------------------
```

#### Datos de captura
\quad

`catch` es una matriz que contiene la siguiente información;

- `year`: años de información de capturas de la flota comercial
- `seas`: mes de captura
- `fleet`: número de flota
- `catch`: datos de captura en número o toneladas según como se ha especificado anteriormente
- `catch_se`: standard error of log(catch)

NOTE:  catch data is ignored for survey fleets


```{r}
#---------------------------------------------------------------------------------
# Arreglo de Datos
year           <- capturas$year # esta información se extrae de los archivos de GADGET
nyear          <- length(year)

catch_year     <- c(rep(-999,4),year)
catch_seas     <- c(seq(1,4,1),capturas$step) # esta información se extrae de los archivos de GADGET
catch_fleet    <- rep(1,nyear+4)
catch_catch    <- c(rep(0,4),capturas$number) # esta información se extrae de los archivos de GADGET
catch_catch_se <- rep(0.01,nyear+4) # se asume cv = 0.01 Revisar!!!!
catch1<-data.frame(year     = catch_year,
                   seas     = catch_seas,
                   fleet    = catch_fleet,
                   catch    = catch_catch,
                   catch_se = catch_catch_se)
dat1$catch<-catch1 
#---------------------------------------------------------------------------------
# revisar salida final
head(dat1$catch, n=15)
#---------------------------------------------------------------------------------
```

- La primera línea del fragmento de código anterior muestra los encabezados de columna para los datos de captura. 

- Tenga en cuenta que toda la captura proviene de la pesquería. La línea `-999 1 1 0 0.01` especifica la captura  de equilibrio para los años anteriores al inicio del modelo; en este caso, no hay captura de equilibrio porque la columna de captura es 0.

### Indices de abundancia formato `SS3`

Luego viene la especificación de los índices de abundancia.  Primero está la configuración para todas las flotas. 

[Consulte la Guía de usuario de SS3: Sección 7.10 "Indices"](https://nmfs-stock-synthesis.github.io/doc/SS330_User_Manual.html#indices).

#### Especificaciones de los índices de abundancia (CPUE y/o Campañas)
\quad

`CPUEinfo` Es una matriz que contiene la siguiente información;

- `Fleet`:
- `Units`:  0=numbers; 1=biomass; 2=F; >=30 for special types
- `Errtype`:  -1=normal; 0=lognormal; >0=T
- `SD_Report`: 0=no sdreport; 1=enable sdreport


```{r}
#---------------------------------------------------------------------------------
# Arreglo de datos
CPUEinfo_Fleet     <- c(1,2,3)
CPUEinfo_Units     <- c(1,1,1) 
CPUEinfo_Errtype   <- c(0,0,0) 
CPUEinfo_SD_Report <- c(0,0,0) 
CPUEinfo_names     <-fleetnames1  
CPUEinfo1<-data.frame(Fleet     = CPUEinfo_Fleet,
                      Units     = CPUEinfo_Units,
                      Errtype   = CPUEinfo_Errtype,
                      SD_Report = CPUEinfo_SD_Report)
row.names(CPUEinfo1)<-CPUEinfo_names
dat1$CPUEinfo<-CPUEinfo1 
#---------------------------------------------------------------------------------
# revisar salida final
dat1$CPUEinfo
#---------------------------------------------------------------------------------
```

- Los encabezados de las columnas de esta sección están directamente encima de los números. Tenga en cuenta que aquí se definen todas las flotas (es decir, cada flota necesita una línea), incluida la pesquería, y se enumeran en el mismo orden que cuando se especificaron los tipos de flota.

- Lo más importante en esta sección es que se especifican las unidades y el tipo de error que se utilizará al leer los índices de abundancia. 

- En este caso, la pesquería y las campañas  tienen unidades de biomasa. Revisar que pasa si lo cambiamos a número. Se asume un error logarítmico normal para las 3 flotas.

- Inmediatamente después de su encabezado, se incluyen los datos de índices de abundancia:

#### Datos de índices de abundancia
\quad

`CPUE` es una matriz que contiene la siguiente información:

- `year`:
- `seas`:
- `index`:
- `obs`:
- `se_log`:


```{r}
#---------------------------------------------------------------------------------
# Arreglo de datos
CPUE_year  <-c(pelago$year,ecocadiz$year) 
CPUE_seas  <-rep(1,length(CPUE_year)) 
CPUE_index <-c(rep(2,length(pelago$year)),rep(3,length(ecocadiz$year))) 
CPUE_obs   <-c(pelago$number,ecocadiz$number)  
CPUE_se_log<-c(rep(0.3,length(pelago$year)),rep(0.3,length(ecocadiz$year))) 

CPUE1<-data.frame(year   = CPUE_year,
                  seas   = CPUE_seas,
                  index  = CPUE_index,
                  obs    = CPUE_obs,
                  se_log = CPUE_se_log)
dat1$CPUE<-CPUE1 
#---------------------------------------------------------------------------------
# revisar salida final
head(dat1$CPUE,n=10)
#---------------------------------------------------------------------------------
```

### Descartes y tallas medias Formato `SS3`

A continuación, se podrían especificar los datos de descartes y tallas media.

[Consulte la Guía de usuario de SS3: Sección 7.11 "Discard"](https://nmfs-stock-synthesis.github.io/doc/SS330_User_Manual.html#discard).

#### Descarte
\quad

`N_discard_fleets`:

```{r}
#---------------------------------------------------------------------------------
dat1$N_discard_fleets<-0 
dat1$N_discard_fleets
#---------------------------------------------------------------------------------
```

#### Tallas medias
\quad

`use_meanbodywt`:

```{r}
#---------------------------------------------------------------------------------
dat1$use_meanbodywt<-0 
dat1$use_meanbodywt
#---------------------------------------------------------------------------------
```

### Composición de tallas Formato `SS3`

La siguiente sección configura los intervalos de talla (`length bin`) de la población. 

Esto debe especificarse ya sea que se utilicen o no datos de composiciones de tallas (aunque podría generar los intervalos de longitud de la población a partir de los intervalos de datos de composiciones de tallas). 

[Consulte la Guía de usuario de SS3: Sección 7.14 "Length Composition Data Structure"](https://nmfs-stock-synthesis.github.io/doc/SS330_User_Manual.html#length-composition-data-structure).

#### Bins tallas
\quad

set up population length bin structure (note - irrelevant if not using size data and using empirical wtatage)

- `lbin_method`:  length bin method: 1=use databins; 2=generate from binwidth,min,max below; 3=read vector
- `binwidth`: binwidth for population size comp 
- `minimum_size`: minimum size in the population (lower edge of first bin and size at age 0.00)
- `maximum_size`: maximum size in the population (lower edge of last bin)  
- `use_lencomp`: use length composition data (0/1)

```{r}
#---------------------------------------------------------------------------------
dat1$lbin_method  <-2     
dat1$binwidth     <-0.5   
dat1$minimum_size <-0    
dat1$maximum_size <-21.5   
dat1$use_lencomp  <-1     
#---------------------------------------------------------------------------------
#revisar salida final
dat1[26:30]
#---------------------------------------------------------------------------------
```

Después de los intervalos de tallas de la población está la especificación para la composición de tallas (asumiendo 1 línea por flota):

#### Especificación composición de tallas
\quad

`len_info` es una matriz que contiene la siguiente información:

- `mintailcomp`:  upper and lower distribution for females and males separately are accumulated until exceeding this level.
- `addtocomp`:    after accumulation of tails; this value added to all bins
- `combM+F`:      males and females treated as combined gender below this bin number 
- `compressbins`: accumulate upper tail by this number of bins; acts simultaneous with mintailcomp; set=0 for no forced accumulation
- `Comp_Error`:   0=multinomial, 1=dirichlet using Theta*n, 2=dirichlet using beta,3=MV_Tweedie
- `ParmSelect`:   consecutive index for dirichlet or MV_Tweedie
- `minsamplesize`: minimum sample size; set to 1 to match 3.24, minimum value is 0.001

```{r}
#---------------------------------------------------------------------------------
# Arreglo de datos
nfleets<-dat1$Nfleets
len_info_mintailcomp   <-rep(-1,nfleets)
len_info_addtocomp     <-rep(0.001,nfleets)
len_info_combine_M_F   <-rep(0,nfleets)
len_info_CompressBins  <-rep(0,nfleets)
len_info_CompError     <-rep(0,nfleets)
len_info_ParmSelect    <-rep(0,nfleets)
len_info_minsamplesize <-rep(1,nfleets)
len_info1<-data.frame(mintailcomp     = len_info_mintailcomp,
                        addtocomp     = len_info_addtocomp,
                        combine_M_F   = len_info_combine_M_F,
                        CompressBins  = len_info_CompressBins,
                        CompError     = len_info_CompError,
                        ParmSelect    = len_info_ParmSelect,
                        minsamplesize = len_info_minsamplesize)
row.names(len_info1)<-fleetnames1 
dat1$len_info<-len_info1
#---------------------------------------------------------------------------------
# revisar salida final
dat1$len_info
#---------------------------------------------------------------------------------
```

#### Especificación del vector de tallas
\quad

```{r}
#---------------------------------------------------------------------------------
dat1$N_lbins<-37  
dat1$lbin_vector<-seq(3.5,21.5,0.5) 
#---------------------------------------------------------------------------------
# revisar salida final
dat1[32:33]
#---------------------------------------------------------------------------------
```

#### Datos de composición de tallas
\quad

`lencomp` es una matriz que contiene la siguiente información:

- `Yr`:
- `Seas`:
- `FltSvy`:
- `Gender`: sex codes:  0=combined; 1=use female only; 2=use male only; 3=use both as joint sexxlength distribution
- `Part`: partition codes:  (0=combined; 1=discard; 2=retained
- `Nsamp`:


```{r }
# #---------------------------------------------------------------------------------
# Arreglo de datos
#---------------------------------------------------------------------------------
tallasplot<-merge(tallasflota,
            merge(tallaspelago,tallasecocadiz,
                  by=c('year','step','area','age','length',"text"),all=TRUE),
                  by=c('year','step','area','age','length',"text"),all=TRUE) %>% 
            select(-area, -age,-text)%>% 
            magrittr::set_colnames(c('year','step','length','FLOTA','PELAGO','ECOCADIZ')) %>%
            mutate(Gender=0,
                      Part=0,
                      Nsamp=100) %>%
            melt(id.vars=c('year','step','length','Gender','Part','Nsamp')) %>% 
            spread(length,value) 

tallasSS3<-tallasplot[order(tallasplot$variable),]
tallasSS3[is.na(tallasSS3)] <- 0              
nyear<-length(tallasSS3$year)/3

new_lencomp <- data.frame(Yr     = tallasSS3$year, 
                          Seas   = tallasSS3$step, 
                          FltSvy = c(rep(1,nyear),rep(2,nyear),rep(3,nyear)), 
                          Gender = tallasSS3$Gender, 
                          Part   = tallasSS3$Part, 
                          Nsamp  = tallasSS3$Nsamp)

dat_rows_names <- paste("L",seq(3.5,21.5,0.5) ,sep="")

dat_rows <- tallasSS3[,7:43]
names(dat_rows)<-dat_rows_names 
new_lencomp1<-cbind(new_lencomp, dat_rows)

dat1$lencomp<-new_lencomp1 
#---------------------------------------------------------------------------------
# revisar salida final
dat1$lencomp[1:10,1:10]
#---------------------------------------------------------------------------------
```

### Composición de edad Formato `SS3`

A continuación se presentan los datos de composición por edad. En primer lugar, se establecen las categorías de edad y las definiciones de error de edad.

[Consulte la Guía de usuario de SS3: Sección 7.16 "Age Composition Option"](https://nmfs-stock-synthesis.github.io/doc/SS330_User_Manual.html#age-composition-option).

#### Bins de edad
\quad
```{r}
#---------------------------------------------------------------------------------
dat1$N_agebins<-0
dat1$N_agebins
dat1$agebin_vector<-NULL
dat1$agebin_vector
#---------------------------------------------------------------------------------
```

#### Datos de error edad
\quad

Aquí se ingresa la matriz se error de lectura de edad, si no se ingresa datos de edad entonces de deja `NULL`

`ageerror` es una matriz que contiene la siguiente información:


```{r}
#---------------------------------------------------------------------------------
dat1$N_ageerror_definitions<- NULL 
dat1$N_ageerror_definitions
dat1$ageerror<-NULL 
dat1$ageerror
#---------------------------------------------------------------------------------
```

#### Especificaciones de los datos de composicion de edad
\quad

`age_info` es una matriz que contiene las especificaciones de los datos de composición de edad. A continuación se detalla el contenido de esta matriz:

- `mintailcomp`:  upper and lower distribution for females and males separately are accumulated until exceeding this level.
- `addtocomp`:    after accumulation of tails; this value added to all bins
- `combM+F`:      males and females treated as combined gender below this bin number 
- `compressbins`: accumulate upper tail by this number of bins; acts simultaneous  with mintailcomp; set=0 for no forced accumulation
- `Comp_Error`:   0=multinomial, 1=dirichlet using Theta*n, 2=dirichlet using beta, 3=MV_Tweedie
- `ParmSelect`:   consecutive index for dirichlet or MV_Tweedie
- `minsamplesize`: minimum sample size; set to 1 to match 3.24, minimum value is 0.001


```{r}
#---------------------------------------------------------------------------------
dat1$age_info<-NULL
dat1$age_info
#---------------------------------------------------------------------------------
```

#### Datos de composicion de edad
\quad

`Lbin_method` se debe ingresar una de las siguientes opciones; 1=poplenbins; 2=datalenbins; 3=lengths
`agecomp`: es una matriz que contiene la siguiente información:

- `Yr`:
- `Seas`:
- `FltSvy`:
- `Gender`: sex codes:  0=combined;1=use female only; 2=use male only; 3=use both as joint sexxlength distribution
- `Part`: partition codes:  (0=combined; 1=discard; 2=retained
- `Ageerr`: 
- `Lbin_lo`:
- `Lbin_hi`:
- `Nsamp`:

NOTA: si no se ingresan datos de edad entonces `Lbin_method` y `agecomp` = `NULL`

```{r}
#---------------------------------------------------------------------------------
dat1$Lbin_method <- NULL 
dat1$Lbin_method
#---------------------------------------------------------------------------------
# Arreglo de datos
new_agecomp<-data.frame(Yr=0, 
                        Seas=0, 
                        FltSvy=0, 
                        Gender=0, 
                        Part=0,  
                        Ageerr=0, 
                        Lbin_lo=0, 
                        Lbin_hi=0, 
                        Nsamp=0)
dat_rows_names<- paste("E",seq(0,5,1),sep="")
#names(data.age)<-dat_rows_names 
dat1$agecomp<-NULL
dat1$agecomp
#---------------------------------------------------------------------------------

#---------------------------------------------------------------------------------
``` 


### Otros datos

#### Tallas medias a la edad
\quad

`use_MeanSize_at_Age_obs`: Use_MeanSize-at-Age_obs (0/1)
`MeanSize_at_Age_obs` es una matriz que contiene la siguiente información:

- `Yr`:
- `Seas`:
- `FltSvy`:
- `Gender`:  sex codes:  0=combined;1=use female only; 2=use male only; 3=use both as joint sexxlength distribution
- `Part`: partition codes:  (0=combined;  1=discard;  2=retained
- `AgeErr`: ageerr codes:  positive means mean length-at-age; negative means mean bodywt_at_age
- `Ignore`:

NOTA: si no se ingresan datos de tallas medias a la edad  entonces `use_MeanSize_at_Age_obs` = 0 y `MeanSize_at_Age_obs` = `NULL`

```{r}
#---------------------------------------------------------------------------------
dat1$use_MeanSize_at_Age_obs <- 0 
dat1$use_MeanSize_at_Age_obs
#---------------------------------------------------------------------------------
# Arreglo de datos
MeanSize_at_Age_obs_esp<-data.frame(Yr=0,
                                    Seas=0,
                                    FltSvy=0,
                                    Gender=0,
                                    Part=0,
                                    AgeErr=0,
                                    Ignore=0)

dat_rows_names <- c(paste("L",seq(0,5,1),sep=""),paste("nmL",seq(0,5,1),sep="")) 
dat_rows <- as.data.frame(matrix(data = 0, 
                                 nrow = nrow(MeanSize_at_Age_obs_esp), 
                                 ncol = length(dat_rows_names)))
names(dat_rows)<-dat_rows_names 
#---------------------------------------------------------------------------------
# crear data.frame 
MeanSize_at_Age_obs1 <-cbind(MeanSize_at_Age_obs_esp, dat_rows)
#---------------------------------------------------------------------------------
dat1$MeanSize_at_Age_obs<-NULL #MeanSize_at_Age_obs1
dat1$MeanSize_at_Age_obs
#---------------------------------------------------------------------------------
```

#### Datos ambientales 
\quad


```{r}
dat1$N_environ_variables<-0 
dat1$N_environ_variables
```

#### Sizefreq data 
\quad
```{r}
dat1$N_sizefreq_methods<-0 
dat1$N_sizefreq_methods
```

#### Datos de tags
\quad

```{r}
dat1$do_tags<-0 
dat1$do_tags
```

#### Datos de morfos 
\quad

```{r}
dat1$morphcomp_data<-0 
dat1$morphcomp_data
```

##### Priors de selectividad
\quad

```{r}
dat1$use_selectivity_priors<-0 
dat1$use_selectivity_priors
```

#### Final de archivo data.ss
\quad
imprime línea final
```{r}
dat1$eof<-TRUE 
dat1$eof


```



##  Escribir archivo de datos modificado con la función  `SS_write` para el enfoque de modelación `SS3`
```{r eval=T}
r4ss::SS_writedat(dat1,outfile=here(dirname.simple_mod,"data.ss"),overwrite = TRUE)
```

